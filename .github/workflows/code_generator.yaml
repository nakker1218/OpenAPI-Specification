name: OpenAPI Generator
on:
  - pull_request
jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Generate client library
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: dart-dio
          openapi-file: petstore.yaml
          generator-tag: v6.0.0
          command-args: >-
            -o client
      - name: Copy files generated by OpenAPI
        run: |
          cp -r client /home/runner/work/_temp/client
      - name: Move to client repository
        id: move-client-repository
        uses: actions/checkout@v3
        with:
          repository: 'nakker1218/OpenAPI-Client'
          ssh-key: ${{ secrets.SSH_DEPLOY_KEY }}
          ref: ${{ github.head_ref }}
        continue-on-error: true
      - name: Create branch
        id: create-branch
        run: |
          git checkout main
          git checkout -b ${{ github.head_ref }}
        if: steps.move-client-repository.outcome == 'failure'
      - name: Paste files generated by OpenAPI
        run: |
          git branch
          cd /home/runner/work/_temp/client
          ls -l
          cp -r . /home/runner/work/OpenAPI-Specification/OpenAPI-Specification
          cd /home/runner/work/OpenAPI-Specification/OpenAPI-Specification
      - name: Setup flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ secrets.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          cache-key: flutter
          cache-path: ${{ runner.tool_cache }}/flutter
      - name: Run build_runner
        run: |
          cd /home/runner/work/OpenAPI-Specification/OpenAPI-Specification
          flutter pub get
          flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Diff
        id: diff
        run: |
          git add -N .
          git diff --name-only --exit-code
        continue-on-error: true
      - name: Commit & Push
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git commit -m "Update from $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/${{ github.sha }}"
          git push --set-upstream origin ${{ github.head_ref }}
        if: steps.diff.outcome == 'failure'
      - name: Create comment
        uses: mshick/add-pr-comment@v1
        if: steps.create-branch.outcome == 'success'
        with:
          message: |
            pubspec.yaml
            ```
              openapi:
                git:
                url: https://github.com/nakker1218/OpenAPI-Client.git
                ref: ${{ github.head_ref }}
            ```
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          repo-token-user-login: 'github-actions[bot]'


